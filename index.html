<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Canvas</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        canvas {
            touch-action: none;
            cursor: crosshair;
        }
        .toolbar {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        /* Helper to hide/show views */
        .view {
            display: none; /* All views hidden by default */
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen">

    <!-- 1. Authentication View (Shown when logged out) -->
    <div id="auth-view" class="view items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm mx-4">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Sign In</h2>
            
            <button id="google-signin-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 transition">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Sign in with Google
            </button>
            <div class="my-4 flex items-center before:flex-1 before:border-t before:border-gray-300 after:flex-1 after:border-t after:border-gray-300">
                <p class="text-center text-sm text-gray-500 mx-4">or</p>
            </div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <p id="auth-error" class="text-red-500 text-sm text-center mt-4 h-5"></p>
            <div id="signin-actions" class="flex flex-col gap-4 mt-6">
                <button id="email-signin-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">Sign In</button>
                <a href="#signup" class="text-center text-sm text-blue-500 hover:underline">Don't have an account? Sign Up</a>
            </div>
            <div id="signup-actions" class="flex flex-col gap-4 mt-6" style="display: none;">
                <button id="email-register-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition">Register</button>
                <a href="#signin" class="text-center text-sm text-blue-500 hover:underline">Already have an account? Sign In</a>
            </div>
        </div>
    </div>

    <!-- 2. Main App View (Shown when logged in) -->
    <div id="app-view" class="view flex-col">
        <!-- Shared Header -->
        <header class="bg-white p-3 shadow-md z-10 w-full">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center max-w-6xl">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-blue-600">Canvas</h1>
                    <nav class="flex gap-2">
                        <a href="#home" id="nav-home" class="nav-link px-3 py-1 rounded-md text-sm font-medium">My Canvases</a>
                        <a href="#shared-with-me" id="nav-shared" class="nav-link px-3 py-1 rounded-md text-sm font-medium">Shared With Me</a>
                    </nav>
                </div>
                <div class="text-xs text-gray-500 text-center sm:text-right mt-2 sm:mt-0">
                    <div id="auth-status" class="font-medium text-gray-700 items-center flex gap-2">
                        <span id="auth-status-name">Loading...</span>
                        <button id="sign-out-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs px-2 py-1 rounded-md">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page 1: Home Page (#home) -->
        <div id="home-page" class="view flex-col flex-1 overflow-auto">
            <div class="p-4 container mx-auto max-w-6xl">
                <button id="create-canvas-btn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition mb-6">
                    Create New Canvas
                </button>
                <div id="canvas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500">Loading your canvases...</p>
                </div>
            </div>
        </div>
        
        <!-- Page 2: Shared With Me Page (#shared-with-me) -->
        <div id="shared-with-me-page" class="view flex-col flex-1 overflow-auto">
            <div class="p-4 container mx-auto max-w-6xl">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Canvases Shared With Me</h2>
                <div id="shared-canvas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500">Loading shared canvases...</p>
                </div>
            </div>
        </div>

        <!-- Page 3: Canvas Page (#canvas?id=) -->
        <div id="canvas-page" class="view flex-col flex-1">
            <!-- Canvas Toolbar -->
            <nav class="bg-white p-3 flex flex-wrap justify-center items-center gap-4 toolbar z-10">
                <a href="#home" class="text-blue-500 hover:underline text-sm font-medium">&larr; Back to Home</a>
                <div class="flex items-center gap-2">
                    <label for="color-picker" class="text-sm font-medium text-gray-700">Color:</label>
                    <input type="color" id="color-picker" value="#000000" class="w-10 h-10 rounded-full border-2 border-gray-300 p-0 m-0 cursor-pointer">
                </div>
                <div class="flex items-center gap-2">
                    <label for="brush-size" class="text-sm font-medium text-gray-700">Size:</label>
                    <input type="range" id="brush-size" min="1" max="50" value="5" class="w-32 sm:w-48 cursor-pointer">
                    <span id="brush-size-label" class="text-sm text-gray-600 w-4 text-right">5</span>
                </div>
                <button id="clear-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Clear All</button>
                <button id="share-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition" style="display: none;">Share</button>
                <div class="text-xs text-gray-500">
                    Canvas ID: <strong id="canvas-id-display" class="text-blue-500">...</strong>
                </div>
            </nav>
            <!-- Canvas Area -->
            <main class="flex-1 overflow-hidden p-4">
                <canvas id="drawing-canvas" class="w-full h-full bg-white rounded-lg shadow-inner"></canvas>
            </main>
        </div>
    </div>
    
    <!-- Global Error Toast/Notification -->
    <div id="error-toast" class="fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50" style="display: none;">
        <span id="error-toast-message"></span>
        <button id="error-toast-close" class="ml-4 font-bold">X</button>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Share Canvas</h2>
            <div class="flex gap-2 mb-4">
                <input id="share-email-input" type="email" placeholder="Enter email to share with" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="add-share-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">Add</d>
            </div>
            <p id="share-error" class="text-red-500 text-sm mb-4 h-5"></p>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Shared With:</h3>
            <div id="shared-users-list" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-gray-500">Loading...</p>
            </div>
            
            <button id="close-share-modal-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                Close
            </button>
        </div>
    </div>


    <!-- 3. Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            setDoc, 
            updateDoc, 
            arrayUnion,
            arrayRemove,
            collection,
            addDoc,
            query,
            where,
            getDocs,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDV0610fdTZI1-osEdbip00F6DbpQ7_etg",
            authDomain: "artworld-af3ba.firebaseapp.com",
            projectId: "artworld-af3ba",
            storageBucket: "artworld-af3ba.firebasestorage.app",
            messagingSenderId: "803491808581",
            appId: "1:803491808581:web:0222411e06d8b5d627ea2c",
            measurementId: "G-517EVBC6PN"
        };

        // --- Global Variables ---
        let db, auth, app;
        let userId, userEmail;
        let currentCanvasId, currentDocRef; 
        let pageListener = null; // Single listener for home/shared pages
        let canvasPageListener = null;
        let canvasData = null; // Cache for canvas data

        // UI Elements
        let canvas, ctx;
        let drawing = false, lastPos;
        let colorPicker, brushSizeSlider, brushSizeLabel, clearButton, shareButton;
        
        let currentLines = [];

        /**
         * 1. Entry Point: Called on window load
         */
        window.onload = () => {
            initFirebase();
            bindAuthUI();
            bindToolbar();
            bindHomePageUI();
            bindShareModalUI();
            bindGlobalErrorToast();
            window.onhashchange = router; // Listen for hash changes
        };

        /**
         * 2. Initialize Firebase and Auth Listener
         */
        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                handleAuthentication();
            } catch (e) { console.error("Error initializing Firebase:", e); }
        }

        /**
         * 3. Handle User Authentication State
         */
        function handleAuthentication() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userEmail = user.email;
                    document.getElementById('auth-status-name').innerText = userEmail || 'Signed In';
                    document.getElementById('sign-out-btn').onclick = handleSignOut;
                    router();
                } else {
                    userId = null;
                    userEmail = null;
                    cleanupListeners();
                    window.location.hash = "#signin"; 
                    router();
                }
            });
        }
        
        /**
         * 4. Main Router Function
         */
        function router() {
            const hash = window.location.hash || "#home";
            const user = auth.currentUser;

            cleanupListeners();
            
            // Hide all views
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'none';
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('shared-with-me-page').style.display = 'none';
            document.getElementById('canvas-page').style.display = 'none';
            
            // Reset nav link styles
            document.getElementById('nav-home').classList.remove('bg-blue-100', 'text-blue-700');
            document.getElementById('nav-shared').classList.remove('bg-blue-100', 'text-blue-700');

            if (user) {
                document.getElementById('app-view').style.display = 'flex';

                if (hash.startsWith("#canvas?id=")) {
                    const id = new URLSearchParams(hash.split('?')[1]).get('id');
                    loadCanvasPage(id);
                } else if (hash === "#shared-with-me") {
                    document.getElementById('nav-shared').classList.add('bg-blue-100', 'text-blue-700');
                    loadSharedWithMePage();
                } else {
                    // Default to home page
                    document.getElementById('nav-home').classList.add('bg-blue-100', 'text-blue-700');
                    loadHomePage();
                }
            } else {
                document.getElementById('auth-view').style.display = 'flex';
                if (hash === "#signup") {
                    document.getElementById('auth-title').innerText = 'Register';
                    document.getElementById('signin-actions').style.display = 'none';
                    document.getElementById('signup-actions').style.display = 'flex';
                } else {
                    document.getElementById('auth-title').innerText = 'Sign In';
                    document.getElementById('signin-actions').style.display = 'flex';
                    document.getElementById('signup-actions').style.display = 'none';
                }
            }
        }

        /**
         * 5. Cleanup Listeners
         */
        function cleanupListeners() {
            if (pageListener) { pageListener(); pageListener = null; }
            if (canvasPageListener) { canvasPageListener(); canvasPageListener = null; }
            clearCanvasDrawing();
        }

        /**
         * 6. Bind Auth UI
         */
        function bindAuthUI() {
            document.getElementById('google-signin-btn').onclick = handleGoogleSignIn;
            document.getElementById('email-signin-btn').onclick = handleEmailSignIn;
            document.getElementById('email-register-btn').onclick = handleEmailRegister;
        }

        function bindGlobalErrorToast() {
            document.getElementById('error-toast-close').onclick = () => {
                document.getElementById('error-toast').style.display = 'none';
            };
        }

        function showErrorToast(message) {
            document.getElementById('error-toast-message').innerText = message;
            document.getElementById('error-toast').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-toast').style.display = 'none';
            }, 3000);
        }

        // --- Auth Handlers ---
        function showAuthError(message) {
            document.getElementById('auth-error').innerText = message;
        }
        async function handleGoogleSignIn() {
            showAuthError("");
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (e) { console.error(e); showAuthError(e.message); }
        }
        async function handleEmailSignIn() {
            showAuthError("");
            const e = document.getElementById('email-input').value, p = document.getElementById('password-input').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (e) { console.error(e); showAuthError(e.message); }
        }
        async function handleEmailRegister() {
            showAuthError("");
            const e = document.getElementById('email-input').value, p = document.getElementById('password-input').value;
            try { await createUserWithEmailAndPassword(auth, e, p); } 
            catch (e) { console.error(e); showAuthError(e.message); }
        }
        async function handleSignOut() {
            try { await signOut(auth); } 
            catch (e) { console.error(e); }
        }

        // --- Home Page Logic ---

        function bindHomePageUI() {
            document.getElementById('create-canvas-btn').onclick = createNewCanvas;
        }
        
        function loadHomePage() {
            document.getElementById('home-page').style.display = 'flex';
            // Query for canvases *this user owns*
            const q = query(collection(db, "users", userId, "canvases"));
            
            pageListener = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('canvas-list');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 col-span-full">You don\'t have any canvases yet.</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach((doc) => {
                    listEl.appendChild(createCanvasCard(doc.id, doc.data(), true));
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.onclick = () => deleteCanvas(btn.dataset.id);
                });

            }, (e) => {
                console.error(e);
                document.getElementById('canvas-list').innerHTML = '<p class="text-red-500 col-span-full">Error loading canvases.</p>';
            });
        }

        // --- Shared With Me Page Logic ---
        
        function loadSharedWithMePage() {
            document.getElementById('shared-with-me-page').style.display = 'flex';
            
            // Query for canvases *shared with this user's email*
            const q = query(collection(db, "canvases"), where("sharedWith", "array-contains", userEmail));
            
            pageListener = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('shared-canvas-list');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 col-span-full">No canvases have been shared with you.</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach((doc) => {
                    // Pass `false` for `isOwner`
                    listEl.appendChild(createCanvasCard(doc.id, doc.data(), false));
                });
            }, (e) => {
                console.error(e);
                document.getElementById('shared-canvas-list').innerHTML = '<p class="text-red-500 col-span-full">Error loading shared canvases.</p>';
            });
        }
        
        // --- Canvas Card Creation (Reusable) ---
        
        function createCanvasCard(canvasId, canvasData, isOwner) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-md flex justify-between items-center';
            
            let date = '...';
            if (canvasData.createdAt?.toDate) {
                date = canvasData.createdAt.toDate().toLocaleDateString();
            } else if (!isOwner) {
                date = canvasData.ownerEmail || 'Unknown Owner'; // Show owner email if not owned
            }

            card.innerHTML = `
                <div>
                    <h3 class="font-bold text-lg text-gray-800">${canvasData.name || 'Untitled'}</h3>
                    <p class="text-sm text-gray-500">${isOwner ? 'Created' : 'Shared by'}: ${date}</p>
                </div>
                <div class="flex gap-2">
                    <a href="#canvas?id=${canvasId}" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition text-sm">
                        Open
                    </a>
                    ${isOwner ? `<button data-id="${canvasId}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition text-sm">Delete</button>` : ''}
                </div>
            `;
            return card;
        }

        // --- Canvas CRUD ---

        async function createNewCanvas() {
            const canvasName = prompt("Enter a name for your new canvas:", "Untitled Canvas");
            if (!canvasName || canvasName.trim() === "") return;

            try {
                // We must create *both* documents
                const newCanvasRef = doc(collection(db, "canvases"));
                const newCanvasId = newCanvasRef.id;

                // 1. Create the (private) metadata document
                await setDoc(doc(db, "users", userId, "canvases", newCanvasId), {
                    name: canvasName,
                    createdAt: serverTimestamp(),
                    ownerId: userId
                });
                
                // 2. Create the (public) data document
                await setDoc(newCanvasRef, {
                    name: canvasName,
                    ownerId: userId,
                    ownerEmail: userEmail,
                    sharedWith: [], // Initially shared with no one
                    lines: []
                });

                window.location.hash = `#canvas?id=${newCanvasId}`;
            } catch (e) { console.error("Error creating new canvas: ", e); }
        }

        async function deleteCanvas(canvasId) {
            // Skipping a custom confirmation modal
            try {
                // 1. Delete the private metadata
                await deleteDoc(doc(db, "users", userId, "canvases", canvasId));
                // 2. Delete the public drawing data
                await deleteDoc(doc(db, "canvases", canvasId));
                // onSnapshot will update the UI
            } catch (e) { console.error("Error deleting canvas: ", e); }
        }

        // --- Canvas Page Logic ---

        function bindToolbar() {
            colorPicker = document.getElementById('color-picker');
            brushSizeSlider = document.getElementById('brush-size');
            brushSizeLabel = document.getElementById('brush-size-label');
            clearButton = document.getElementById('clear-btn');
            shareButton = document.getElementById('share-btn');

            brushSizeSlider.oninput = (e) => { brushSizeLabel.innerText = e.target.value; };
            clearButton.onclick = handleClearCanvas;
            shareButton.onclick = () => document.getElementById('share-modal').style.display = 'flex';
        }

        function loadCanvasPage(id) {
            document.getElementById('canvas-page').style.display = 'flex';
            document.getElementById('canvas-id-display').innerText = id;
            shareButton.style.display = 'none'; // Hide by default

            currentCanvasId = id;
            currentDocRef = doc(db, "canvases", currentCanvasId);
            
            setupCanvas();
            listenToCanvasChanges();
        }

        function setupCanvas() {
            canvas = document.getElementById('drawing-canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchend', stopDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
        }
        
        function resizeCanvas() {
            if (!ctx) return;
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            redrawCanvas(currentLines); 
        }

        function listenToCanvasChanges() {
            if (!currentDocRef) return;
            
            canvasPageListener = onSnapshot(currentDocRef, (doc) => {
                if (doc.exists()) {
                    canvasData = doc.data(); // Cache full document
                    currentLines = canvasData.lines || [];
                    
                    // Check ownership and show Share button
                    if (canvasData.ownerId === userId) {
                        shareButton.style.display = 'block';
                        updateShareModalUsers(canvasData.sharedWith);
                    } else {
                        shareButton.style.display = 'none';
                    }
                } else {
                    showErrorToast("Canvas not found.");
                    window.location.hash = "#home";
                }
                redrawCanvas(currentLines);
            }, (error) => {
                console.error("Error listening to canvas:", error);
                if (error.code === 'permission-denied') {
                    showErrorToast("You do not have access to this canvas.");
                    window.location.hash = "#home";
                }
            });
        }
        
        function clearCanvasDrawing() {
             if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentLines = [];
            currentDocRef = null;
            currentCanvasId = null;
            canvasData = null;
            window.removeEventListener('resize', resizeCanvas);
        }

        function redrawCanvas(lines) {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const line of lines) {
                if (!line || !line.from || !line.to) continue;
                ctx.strokeStyle = line.color; ctx.lineWidth = line.size;
                ctx.beginPath();
                ctx.moveTo(line.from.x * canvas.width, line.from.y * canvas.height);
                ctx.lineTo(line.to.x * canvas.width, line.to.y * canvas.height);
                ctx.stroke();
            }
        }

        // --- Drawing Handlers ---
        function getPos(e) {
            const event = e.touches ? e.touches[0] : e;
            const rect = canvas.getBoundingClientRect();
            return { x: (event.clientX - rect.left) / canvas.width, y: (event.clientY - rect.top) / canvas.height };
        }
        function startDrawing(e) { e.preventDefault(); drawing = true; lastPos = getPos(e); }
        function stopDrawing() { drawing = false; }

        async function draw(e) {
            if (!drawing || !currentDocRef) return;
            e.preventDefault();
            const pos = getPos(e);
            const lineData = { from: lastPos, to: pos, color: colorPicker.value, size: brushSizeSlider.value };
            
            // Draw locally
            ctx.strokeStyle = lineData.color; ctx.lineWidth = lineData.size;
            ctx.beginPath();
            ctx.moveTo(lastPos.x * canvas.width, lastPos.y * canvas.height);
            ctx.lineTo(pos.x * canvas.width, pos.y * canvas.height);
            ctx.stroke();

            // Send to Firestore
            try { await updateDoc(currentDocRef, { lines: arrayUnion(lineData) }); } 
            catch (e) { console.error("Error adding line:", e); }
            lastPos = pos;
        }

        async function handleClearCanvas() {
            if (!currentDocRef || !canvasData) return;
            // Only allow owner or shared users to clear
            if (canvasData.ownerId === userId || canvasData.sharedWith.includes(userEmail)) {
                try { await updateDoc(currentDocRef, { lines: [] }); } 
                catch (e) { console.error("Error clearing canvas:", e); }
            } else {
                showErrorToast("You don't have permission to clear this canvas.");
            }
        }
        
        // --- Share Modal Logic ---
        function bindShareModalUI() {
            document.getElementById('close-share-modal-btn').onclick = () => {
                document.getElementById('share-modal').style.display = 'none';
            };
            document.getElementById('add-share-btn').onclick = handleShareEmail;
        }
        
        function setShareError(message) {
            document.getElementById('share-error').innerText = message;
        }

        function updateShareModalUsers(sharedWithList) {
            const listEl = document.getElementById('shared-users-list');
            listEl.innerHTML = '';
            if (!sharedWithList || sharedWithList.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">Not shared with anyone yet.</p>';
                return;
            }
            sharedWithList.forEach(email => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                item.innerHTML = `
                    <span class="text-sm text-gray-800">${email}</span>
                    <button data-email="${email}" class="remove-share-btn text-red-500 hover:text-red-700 font-bold text-sm">Remove</button>
                `;
                listEl.appendChild(item);
            });
            
            document.querySelectorAll('.remove-share-btn').forEach(btn => {
                btn.onclick = () => handleRemoveShare(btn.dataset.email);
            });
        }
        
        async function handleShareEmail() {
            const emailInput = document.getElementById('share-email-input');
            const email = emailInput.value.trim().toLowerCase();
            setShareError('');

            if (!email) {
                setShareError('Please enter an email.'); return;
            }
            if (email === userEmail) {
                setShareError("You can't share a canvas with yourself."); return;
            }
            if (canvasData.sharedWith.includes(email)) {
                 setShareError('Already shared with this user.'); return;
            }
            
            try {
                await updateDoc(currentDocRef, { sharedWith: arrayUnion(email) });
                emailInput.value = '';
                // onSnapshot will update the modal UI
            } catch (e) {
                console.error(e);
                setShareError('Failed to share. Please try again.');
            }
        }
        
        async function handleRemoveShare(email) {
            try {
                await updateDoc(currentDocRef, { sharedWith: arrayRemove(email) });
                // onSnapshot will update the modal UI
            } catch (e) {
                console.error(e);
                setShareError('Failed to remove user. Please try again.');
            }
        }

    </script>
</body>
</html>


